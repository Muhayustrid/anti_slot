{% load mathx %}
{% load markdownify %}

<!-- Source Info Box (Channel or Video) -->
{% if source_info %}
<div class="source-info-box fade-in">
    {% if source_info.type == "channel" %}
    <!-- Channel Info Layout -->
    <div class="source-content channel-layout">
        <div class="source-avatar">
            <img src="{{ source_info.avatar }}" alt="{{ source_info.name }}" loading="lazy">
        </div>
        <div class="source-details">
            <h2 class="source-title">{{ source_info.name }}</h2>
            <span class="source-subtitle">{{ source_info.custom_url }}</span>
        </div>
    </div>
    {% else %}
    <!-- Video Info Layout -->
    <div class="source-content video-layout">
        <div class="source-thumbnail">
            <img src="{{ source_info.thumbnail }}" alt="{{ source_info.title }}" loading="lazy">
            <div class="play-overlay">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
            </div>
        </div>
        <div class="source-details">
            <h2 class="source-title">{{ source_info.title }}</h2>
            <span class="source-subtitle">{{ source_info.channel_name }}</span>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<div class="summary-dashboard fade-in">
    <div class="stat-card">
        <h3>Total Komentar</h3>
        <p id="statTotal">{{ total_comments }}</p>
    </div>
    <div class="stat-card">
        <h3>Non-Promosi Judi Online</h3>
        <p id="statClean" class="text-clean">{{ clean_count }}</p>
    </div>
    <div class="stat-card">
        <h3>Promosi Judi Online</h3>
        <p id="statGambling" class="text-gambling">{{ judi_count }}</p>
    </div>
</div>

{% if analysis_id and not is_dataset_view %}
<div class="ai-insight-box fade-in" hx-get="{% url 'get_ai_insight' %}?analysis_id={{ analysis_id }}" hx-trigger="load"
    hx-swap="outerHTML">
    <div class="insight-header" aria-expanded="true">
        <div class="insight-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" class="sparkle-icon">
                <path
                    d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
            </svg>
            <h3>AI Insight</h3>
        </div>
    </div>
    <div class="insight-content">
        <div class="loading-state" style="margin-top: 1rem; margin-bottom: 1rem;">
            <div class="spinner" style="width: 24px; height: 24px; margin: 0 auto;"></div>
            <p style="text-align: center; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">Sedang
                menganalisis...</p>
        </div>
    </div>
</div>
{% endif %}

<div class="results-header fade-in"
    style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    {% if is_dataset_view %}
    <div style="display: flex; gap: 1rem; align-items: center;">
        <div class="filter-group" style="margin: 0;">
            <label for="filterSelect">Filter:</label>
            <select id="filterSelect" onchange="filterTable(this.value)">
                <option value="all">Semua</option>
                <option value="gambling">Promosi Judi Online</option>
                <option value="clean">Non-Promosi Judi Online</option>
            </select>
        </div>
    </div>
    <button onclick="exportTableToCSV('dataset_komentar.csv')" class="btn-primary"
        style="padding: 0.5rem 1rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Export CSV
    </button>
    {% else %}
    <h2>Detail Komentar</h2>
    <div class="filter-group">
        <label for="filterSelect">Filter:</label>
        <select id="filterSelect" onchange="filterTable(this.value)">
            <option value="all">Semua</option>
            <option value="gambling">Promosi Judi Online</option>
            <option value="clean">Non-Promosi Judi Online</option>
        </select>
    </div>
    {% endif %}
</div>

<div class="table-responsive fade-in">
    <form id="moderationForm">
        <table class="results-table" id="commentsTable">
            <thead>
                <tr>
                    {% if oauth_ok and not is_dataset_view %}
                    <th style="width: 40px;"><input type="checkbox" id="selectAllCheckbox" onchange="toggleAll(this)">
                    </th>
                    {% else %}
                    {% if not is_dataset_view %}
                    <th style="width: 40px;"></th>
                    {% endif %}
                    {% endif %}
                    <th>Username</th>
                    <th>Komentar</th>
                    <th>Prediksi</th>
                    <th>Probabilitas</th>
                    <th>Waktu</th>
                </tr>
            </thead>
            <tbody id="resultsBody">
                {% for r in rows %}
                <tr class="comment-row" data-type="{{ r.label|yesno:'gambling,clean' }}" data-text="{{ r.text }}"
                    style="cursor: pointer;" hx-post="{% url 'comment_detail' %}"
                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                    hx-vals='js:{text: event.currentTarget.dataset.text}' hx-target="body" hx-swap="beforeend">
                    {% if not is_dataset_view %}
                    <td onclick="event.stopPropagation()">
                        {% if oauth_ok %}
                        <input type="checkbox" name="comment_id" value="{{ r.comment_id }}" class="row-checkbox"
                            onchange="updateFab()" {% if r.label %}checked{% endif %}>
                        {% endif %}
                    </td>
                    {% endif %}
                    <td style="font-weight:500;">{{ r.author }}</td>
                    <td style="max-width:300px;" title="{{ r.text }}">{{ r.text|truncatechars:100 }}</td>
                    <td>
                        <span class="badge {{ r.label|yesno:'badge-gambling,badge-clean' }}">
                            {{ r.label|yesno:'Promosi,Non-Promosi' }}
                        </span>
                    </td>
                    <td>{{ r.proba|mul:100|floatformat:2 }}%</td>
                    <td style="color:var(--text-secondary); font-size: 0.85rem;">{{ r.published_at|date:"d M Y, H:i" }}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="text-align:center; padding: 2rem;">Tidak ada komentar ditemukan.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>
</div>